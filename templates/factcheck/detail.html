{% extends 'base.html' %}

{% block title %}Fact-Check Detail - MMT Budget Response Suite{% endblock %}

{% block extra_head %}
<style>
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .spinner {
        display: inline-block;
        animation: spin 1s linear infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .pulse {
        animation: pulse 2s ease-in-out infinite;
    }
</style>

{% if request.status == 'processing' or request.status == 'submitted' %}
<meta http-equiv="refresh" content="3">
{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Fact-Check Request</h1>
                <p class="text-gray-600">Submitted by {{ request.user.display_name|default:"Anonymous" }} â€¢ {{ request.created_at|timesince }} ago</p>
            </div>
            <span class="px-3 py-1 rounded font-semibold {% if request.severity >= 8 %}bg-red-100 text-red-800{% elif request.severity >= 5 %}bg-yellow-100 text-yellow-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                Severity: {{ request.severity }}/10
            </span>
        </div>

        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-6">
            <h2 class="font-semibold text-gray-900 mb-2">Claim:</h2>
            <p class="text-lg text-gray-800">{{ request.claim_text }}</p>

            {% if request.context %}
            <h3 class="font-semibold text-gray-900 mt-4 mb-2">Context:</h3>
            <p class="text-gray-700">{{ request.context }}</p>
            {% endif %}

            {% if request.timestamp_in_speech %}
            <p class="text-sm text-gray-500 mt-4">Timestamp: {{ request.timestamp_in_speech }}</p>
            {% endif %}
        </div>

        <div class="flex items-center gap-4 mb-6">
            {% if user.is_authenticated %}
            <div id="upvote-button">
                <button
                    onclick="toggleUpvote()"
                    class="px-4 py-2 {% if has_upvoted %}bg-indigo-600{% else %}bg-gray-600{% endif %} text-white rounded-md hover:bg-indigo-700"
                >
                    {% if has_upvoted %}âœ“ Upvoted{% else %}â†‘ Upvote{% endif %} ({{ request.upvotes }})
                </button>
            </div>
            {% endif %}
            <span class="px-3 py-1 rounded text-sm font-medium
                {% if request.status == 'reviewed' or request.status == 'published' %}bg-green-100 text-green-800
                {% elif request.status == 'processing' %}bg-blue-100 text-blue-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {{ request.get_status_display }}
            </span>
        </div>
    </div>

    {% if request.response %}
    <div class="bg-white rounded-lg shadow-lg p-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-6">âœ… Fact-Check Response</h2>

        <div class="space-y-6">
            <div class="border-l-4 border-gray-300 pl-4">
                <h3 class="text-xl font-bold text-gray-900 mb-2">ğŸ“ The Claim</h3>
                <p class="text-gray-700">{{ request.response.the_claim }}</p>
            </div>

            <div class="border-l-4 border-red-500 pl-4">
                <h3 class="text-xl font-bold text-red-700 mb-2">âš ï¸ The Problem</h3>
                <p class="text-gray-700">{{ request.response.the_problem }}</p>
            </div>

            <div class="border-l-4 border-green-500 pl-4">
                <h3 class="text-xl font-bold text-green-700 mb-2">âœ“ The Reality</h3>
                <p class="text-gray-700">{{ request.response.the_reality }}</p>
            </div>

            {% if request.response.the_evidence %}
            <div class="border-l-4 border-blue-500 pl-4">
                <h3 class="text-xl font-bold text-blue-700 mb-2">ğŸ“Š The Evidence</h3>
                <div class="text-gray-700">{{ request.response.the_evidence|linebreaks }}</div>
            </div>
            {% endif %}

            {% if request.response.mmt_perspective %}
            <div class="border-l-4 border-purple-500 pl-4">
                <h3 class="text-xl font-bold text-purple-700 mb-2">ğŸ’¡ The MMT Perspective</h3>
                <p class="text-gray-700">{{ request.response.mmt_perspective }}</p>
            </div>
            {% endif %}

            {% if request.response.citations %}
            <div class="border-l-4 border-yellow-500 pl-4">
                <h3 class="text-xl font-bold text-gray-900 mb-2">ğŸ“š Citations</h3>
                <ul class="list-disc list-inside space-y-1">
                    {% for citation in request.response.citations %}
                    <li>
                        <a href="{{ citation.url }}" target="_blank" class="text-indigo-600 hover:text-indigo-700 underline">
                            {{ citation.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>

        <!-- Share Button -->
        <div class="mt-8 flex gap-4">
            <button onclick="shareToTwitter()" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                ğŸ¦ Share to Twitter
            </button>
        </div>
    </div>
    {% else %}
    <!-- Status: No response yet -->
    {% if request.status == 'processing' %}
    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-8 text-center pulse">
        <div class="text-6xl mb-4 spinner">ğŸ”„</div>
        <h3 class="text-2xl font-bold text-blue-900 mb-2">AI is Processing Your Claim...</h3>
        <p class="text-blue-700 mb-4">Claude is analyzing the claim and generating a comprehensive fact-check.</p>
        <p class="text-sm text-blue-600">â±ï¸ This usually takes 10-30 seconds. Page will auto-refresh.</p>
    </div>
    {% elif request.status == 'submitted' %}
    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-8 text-center pulse">
        <div class="text-6xl mb-4">â³</div>
        <h3 class="text-2xl font-bold text-yellow-900 mb-2">Claim Submitted - Queued for Processing</h3>
        <p class="text-yellow-700 mb-4">Your claim is waiting to be processed by the AI.</p>
        <p class="text-sm text-yellow-600">â±ï¸ Processing will begin shortly. Page will auto-refresh.</p>
    </div>
    {% else %}
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
        <div class="text-6xl mb-4">ğŸ“‹</div>
        <h3 class="text-2xl font-bold text-gray-900 mb-2">Awaiting Fact-Check</h3>
        <p class="text-gray-700">This claim has not been fact-checked yet.</p>
    </div>
    {% endif %}
    {% endif %}

    <div class="mt-8 flex gap-4">
        <a href="{% url 'factcheck:queue' %}" class="px-6 py-3 bg-gray-600 text-white rounded-md hover:bg-gray-700">
            â† Back to Queue
        </a>
        <a href="{% url 'factcheck:submit' %}" class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700">
            Submit Another Claim
        </a>
    </div>
</div>

<script>
function shareToTwitter() {
    const text = encodeURIComponent("Fact-check needed: {{ request.claim_text|truncatewords:20|escapejs }}");
    const url = encodeURIComponent(window.location.href);
    window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}&hashtags=FactCheck,MMT,BudgetDay`, '_blank');
}

function toggleUpvote() {
    fetch('{% url "factcheck:upvote" request.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    }).then(() => window.location.reload());
}
</script>
{% endblock %}
