{% extends 'base.html' %}
{% load htmx_tags %}

{% block title %}Fact-Check Detail - MMT Budget Response Suite{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Fact-Check Request</h1>
                <p class="text-gray-600">Submitted by {{ request.user.display_name }} • {{ request.created_at|timesince }} ago</p>
            </div>
            <span class="px-3 py-1 rounded {{ request.severity|severity_color }}">
                Severity: {{ request.severity }}/10
            </span>
        </div>

        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-6">
            <h2 class="font-semibold text-gray-900 mb-2">Claim:</h2>
            <p class="text-lg text-gray-800">{{ request.claim_text }}</p>

            {% if request.context %}
            <h3 class="font-semibold text-gray-900 mt-4 mb-2">Context:</h3>
            <p class="text-gray-700">{{ request.context }}</p>
            {% endif %}

            {% if request.timestamp_in_speech %}
            <p class="text-sm text-gray-500 mt-4">Timestamp: {{ request.timestamp_in_speech }}</p>
            {% endif %}
        </div>

        <div class="flex items-center gap-4 mb-6">
            <div id="upvote-button">
                <button
                    hx-post="{% url 'factcheck:upvote' request.id %}"
                    hx-swap="outerHTML"
                    hx-target="#upvote-button"
                    class="px-4 py-2 {% if has_upvoted %}bg-indigo-600{% else %}bg-gray-600{% endif %} text-white rounded-md hover:bg-indigo-700"
                >
                    {% if has_upvoted %}✓ Upvoted{% else %}↑ Upvote{% endif %} ({{ request.upvotes }})
                </button>
            </div>
            <span class="px-3 py-1 rounded text-sm {{ request.status|status_color }}">
                {{ request.get_status_display }}
            </span>
        </div>
    </div>

    {% if request.response %}
    <div class="bg-white rounded-lg shadow-lg p-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-6">Fact-Check Response</h2>

        <div class="space-y-6">
            <div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">The Claim</h3>
                <p class="text-gray-700">{{ request.response.the_claim }}</p>
            </div>

            <div>
                <h3 class="text-xl font-bold text-red-700 mb-2">The Problem</h3>
                <p class="text-gray-700">{{ request.response.the_problem }}</p>
            </div>

            <div>
                <h3 class="text-xl font-bold text-green-700 mb-2">The Reality</h3>
                <p class="text-gray-700">{{ request.response.the_reality }}</p>
            </div>

            {% if request.response.the_evidence %}
            <div>
                <h3 class="text-xl font-bold text-blue-700 mb-2">The Evidence</h3>
                <div class="text-gray-700">{{ request.response.the_evidence|linebreaks }}</div>
            </div>
            {% endif %}

            {% if request.response.mmt_perspective %}
            <div>
                <h3 class="text-xl font-bold text-purple-700 mb-2">The MMT Perspective</h3>
                <p class="text-gray-700">{{ request.response.mmt_perspective }}</p>
            </div>
            {% endif %}

            {% if request.response.citations %}
            <div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Citations</h3>
                <ul class="list-disc list-inside space-y-1">
                    {% for citation in request.response.citations %}
                    <li>
                        <a href="{{ citation.url }}" target="_blank" class="text-indigo-600 hover:text-indigo-700">
                            {{ citation.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
        <p class="text-yellow-800">
            {% if request.status == 'processing' %}
            AI is generating the fact-check response... This usually takes 30 seconds.
            {% else %}
            This claim has not been fact-checked yet.
            {% endif %}
        </p>
    </div>
    {% endif %}

    <div class="mt-8">
        <a href="{% url 'factcheck:queue' %}" class="px-6 py-3 bg-gray-600 text-white rounded-md hover:bg-gray-700">
            Back to Queue
        </a>
    </div>
</div>
{% endblock %}
